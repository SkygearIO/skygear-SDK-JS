<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Skygear-SDK-JS</title>
</head>
<body>
  <div id="main">
    <h3>SSO plugin is required in this example</h3>
    <p>
      <label>End Point</label>
      <span id="endpoint"></span>
    </p>
    <p>
      <label>Token</label>
      <span id="accessToken"></span>
    </p>
    <p>
      <label>Username</label>
      <span id="currentUsername"></span>
    </p>
    <p>
      <label>Email</label>
      <span id="currentEmail"></span>
    </p>
    <p>
      <label>Result</label>
      <span id="resultMessage" style="color: green;"></span>
    </p>
    <p>
      <label>Error</label>
      <span id="errorMessage" style="color: red;"></span>
    </p>
    <hr>
    <h4>Social Login - Signup and login user</h4>
    <label>Google sign-in using Popup</label>
    <p>
      <button onclick="loginOAuthProviderWithPopup();">Sign in with google</button>
    </p>
    <label>Google sign-in using Redirect</label>
    <p>
      <button onclick="loginOAuthProviderWithRedirect();">Sign in with google</button>
    </p>
    <p>
      <label>Login redirect result</label>
      <span id="loginRedirectResult"></span>
    </p>
    <hr>
    <h4>Social Login - Link logged in user</h4>
    <label>Google link with Popup</label>
    <p>
      <button onclick="linkOAuthProviderWithPopup();">Link with google</button>
    </p>
    <label>Google link using Redirect</label>
    <p>
      <button onclick="linkOAuthProviderWithRedirect();">Link with google</button>
    </p>
    <p>
      <label>Link redirect result</label>
      <span id="linkRedirectResult"></span>
    </p>
    <hr>
    <p><button onclick="logout();">Logout</button></p>
  </div>
  <script src="/bundle.js"></script>
  <script type="text/javascript">
    var m = document.getElementById("endpoint");
    var token = document.getElementById("accessToken");
    var currentUsername = document.getElementById("currentUsername");
    var currentEmail = document.getElementById("currentEmail");
    var resultMessage = document.getElementById("resultMessage");
    var errorMessage = document.getElementById("errorMessage");
    skygear.config({
      'endPoint': '{{ SKYGEAR_ENDPOINT }}',
      'apiKey': '{{ SKYGEAR_API_KEY }}'
    }).then(function(container) {
      m.textContent = container.endPoint;
      token.innerText = skygear.auth.accessToken;
      if (skygear.auth.currentUser) {
        currentUsername.innerText = skygear.auth.currentUser.username;
        currentEmail.innerText = skygear.auth.currentUser.email;
      }
      // get redirect result when load
      getLoginRedirectResult();
      getLinkRedirectResult();
    }, function(err) {
      console.log(err);
    });
    m.textContent = skygear.endPoint;
    token.innerText = skygear.auth.accessToken;
    logout = function() {
      skygear.auth.logout().then(function() {
        console.log('Logout ok');
        showSuccessResult('Logout ok, cleared accessToken');
        token.innerText = '';
      }, function(error) {
        console.log('Logout failed');
        showErrorResult(error);
      });
    };
    loginOAuthProviderWithPopup = function () {
      skygear.auth.loginOAuthProviderWithPopup("google", {})
      .then(function(authResult) {
        console.info('Login oauth with popup success', authResult);
        showSuccessResult('Login oauth with popup success');
        token.innerText = skygear.auth.accessToken;
        currentUsername.innerText = skygear.auth.currentUser.username;
        currentEmail.innerText = skygear.auth.currentUser.email;
        errorMessage.innerText = "";
      }, function(error) {
        console.error('Login oauth with popup fail', error);
        showErrorResult(error);
      });
    };
    linkOAuthProviderWithPopup = function () {
      skygear.auth.linkOAuthProviderWithPopup("google", {})
      .then(function(authResult) {
        console.info('Link oauth with popup success', authResult);
        showSuccessResult('Link oauth with popup success');
      }, function(error) {
        console.error('Link oauth with popup fail', error);
        showErrorResult(error);
      });
    };
    loginOAuthProviderWithRedirect = function () {
      skygear.auth.loginOAuthProviderWithRedirect("google")
      .catch(function (err) {
        showErrorResult(err);
      });
    };
    linkOAuthProviderWithRedirect = function () {
      skygear.auth.linkOAuthProviderWithRedirect("google")
      .catch(function (err) {
        showErrorResult(err);
      });
    };
    showSuccessResult = function (message) {
      resultMessage.innerText = message;
      errorMessage.innerText = '';
    };
    showErrorResult = function (error) {
      resultMessage.innerText = '';
      errorMessage.innerText = error.error ? "[" + error.error.code + "] " + error.error.message : error;
    };
    getLoginRedirectResult = function () {
      var loginRedirectResult = document.getElementById("loginRedirectResult");
      skygear.auth.getLoginRedirectResult().then(function (user) {
        if (user) {
          showSuccessResult('Login with redirect success');
          loginRedirectResult.innerText = 'Get login redirect result success';
          token.innerText = skygear.auth.accessToken;
          currentUsername.innerText = skygear.auth.currentUser.username;
          currentEmail.innerText = skygear.auth.currentUser.email;
        } else {
          loginRedirectResult.innerText = 'No redirect operation was called';
        }
      }, function(error) {
        showErrorResult(error);
        loginRedirectResult.innerText = 'Get link redirect result fail';
      });
    };
    getLinkRedirectResult = function () {
      var linkRedirectResult = document.getElementById("linkRedirectResult");
      skygear.auth.getLinkRedirectResult().then(function (result) {
        if (result) {
          showSuccessResult(JSON.stringify(result));
          linkRedirectResult.innerText = 'Get link redirect result success';
        } else {
          linkRedirectResult.innerText = 'No redirect operation was called';
        }
      }, function(error) {
        showErrorResult(error);
        linkRedirectResult.innerText = 'Get link redirect result fail';
      });
    };
  </script>
</body>
</html>
